services:
  kyaho-web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_SENTRY_DSN: ${VITE_SENTRY_DSN:-}
    image: kyaho-web:latest
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp
      - /var/cache/nginx
      - /var/run
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    expose:
      - '8080'
    healthcheck:
      test: ['CMD-SHELL', 'wget -q -O /dev/null http://127.0.0.1:8080/healthz || exit 1']
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - traefik-public
    labels:
      - traefik.enable=true
      - traefik.docker.network=${TRAEFIK_NETWORK:-traefik-public}

      - traefik.http.routers.kyaho-web.rule=Host(`${DOMAIN:-example.com}`)
      - traefik.http.routers.kyaho-web.entrypoints=websecure
      - traefik.http.routers.kyaho-web.tls=true
      - traefik.http.routers.kyaho-web.tls.certresolver=${TRAEFIK_CERTRESOLVER:-letsencrypt}
      - traefik.http.routers.kyaho-web.service=kyaho-web
      - traefik.http.services.kyaho-web.loadbalancer.server.port=8080

      - traefik.http.middlewares.kyaho-web-https.redirectscheme.scheme=https
      - traefik.http.routers.kyaho-web-insecure.rule=Host(`${DOMAIN:-example.com}`)
      - traefik.http.routers.kyaho-web-insecure.entrypoints=web
      - traefik.http.routers.kyaho-web-insecure.middlewares=kyaho-web-https

networks:
  traefik-public:
    external: true
    name: ${TRAEFIK_NETWORK:-traefik-public}
